#!/usr/bin/env bash
#-
# Copyright (c) 2020-2021 Hervy Qurrotul Ainu Rozi <hervyqa@pm.me>.
#
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-

# Make sure we don't inherit these from env.

title="LangitKetujuh Tools"
name=$(basename "$0")
installdir=$(which basename)
version="1.3"
license="BSD 2-Clause"
type=$(lsb_release -c | cut -f 2)
musl=$(xbps-query -v -L | grep musl | rev | cut -c17)

usage()
{
echo -e "\n\033[1;33m$title $version\033[0m"
echo -e "\e[3mConfiguring tool and installing third party\e[0m"
echo
    cat <<- EOF
license : $license
usage   : $name [option]
option  : --update      -u    update system

        color profile:
          --adobe-icc   -a    install adobe icc
          --idea-icc    -i    install idealliance icc
          --eci-icc     -i    install eci icc
          --jpma-icc    -j    install japan printing machinery association icc
          --vigc-icc    -g    install vigc icc
          --snap-icc    -g    install snap committee icc
          
        plugin:
          --separate+   -p    install separate+ gimp
        
        fonts:
          --corefonts   -c    install core microsoft fonts

        from repo:
          --wine-emu    -w    install wine emulator
          --fish        -s    install fish shell
          
        fix something:
          --fix-lm      -lm   fix lite-musl
          --fix-lg      -lg   fix lite-glibc
          --fix-pm      -pm   fix pro-musl
          --fix-pg      -pg   fix pro-glibc
          --fix-fonts   -f    fix bitmap fonts

          --help        -h    show this help
          --version     -v    show $name version

EOF
}

gitpro="https://gitlab.com/langitketujuh/pro"
gitlite="https://gitlab.com/langitketujuh/lite"
tmp="$HOME/.cache"
for arg in "$@"; do
    case $arg in
        --script|-s)
            sudo sh -c "curl -fsSL https://langitketujuh.id/sh/l7-tools" > /usr/bin/l7-tools
            chmod +x /usr/bin/l7-tools
            echo ">>>> Finish..."
            ;;
        --update|-u)
          sudo xbps-install -Su
            if [ $type = 'lite-musl' ];
              then
              echo ">>>> Remove config skeleton"
              sudo rm -rf /etc/skel/.config
              echo ">>>> Clone repo"
              git clone --depth 1 $gitlite $tmp/lite >/dev/null 2>&1
              cd $tmp/lite/musl
              echo ">>>> Pull repo"
              git config pull.rebase false
              git pull >/dev/null 2>&1
              echo ">>>> Copying update"
              sudo cp -rf * /
              echo ">>>> Update $type finish..."
            elif [ $type = 'lite-glibc' ];
              then
              echo ">>>> Remove config skeleton"
              sudo rm -rf /etc/skel/.config
              echo ">>>> Clone repo"
              git clone --depth 1 $gitlite $tmp/lite >/dev/null 2>&1
              cd $tmp/lite/glibc
              echo ">>>> Pull repo"
              git config pull.rebase false
              git pull >/dev/null 2>&1
              echo ">>>> Copying update"
              sudo cp -rf * /
              echo ">>>> Update $type finish..."
            elif [ $type = 'pro-musl' ];
              then
              echo ">>>> Remove config skeleton"
              sudo rm -rf /etc/skel/.config
              echo ">>>> Clone repo"
              git clone --depth 1 $gitpro $tmp/pro >/dev/null 2>&1
              cd $tmp/pro/musl
              echo ">>>> Pull repo"
              git config pull.rebase false
              git pull >/dev/null 2>&1
              echo ">>>> Copying update"
              sudo cp -rf * /
              echo ">>>> Update $type finish..."
            elif [ $type = 'pro-glibc' ];
              then
              echo ">>>> Remove config skeleton"
              sudo rm -rf /etc/skel/.config
              echo ">>>> Clone repo"
              git clone --depth 1 $gitpro $tmp/pro >/dev/null 2>&1
              cd $tmp/pro/glibc
              echo ">>>> Pull repo"
              git config pull.rebase false
              git pull >/dev/null 2>&1
              echo ">>>> Copying update"
              sudo cp -rf * /
              echo ">>>> Update $type finish..."
            else
              echo '>>>> Update is failed. Please see \033[1;33ml7-tools --help\033[0m'
            fi
            ;;
        --adobe-icc|-a)
            echo ">>>> Preparing new dir /tmp"
            mkdir $tmp/adobe-icc >/dev/null 2>&1
            cd $tmp/adobe-icc
            echo ">>>> Download Adobe ICC Profiles"
            wget -c https://download.adobe.com/pub/adobe/iccprofiles/mac/AdobeICCProfilesCS4Mac_end-user.zip >/dev/null 2>&1
            echo ">>>> Unzip"
            unzip -o -q AdobeICCProfilesCS4Mac_end-user.zip >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/adobe/rgb */RGB/*.icc
            sudo install -D -m644 -t /usr/share/color/icc/adobe/cmyk */CMYK/*.icc
            sudo install -D -m644 -t /usr/share/doc/adobe */*.pdf
            echo ">>>> Finish..."
            ;;
        --eci-icc|-e)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/eci-icc >/dev/null 2>&1
            cd $tmp/eci-icc
            echo ">>>> Download ECI ICC Profiles"
            wget -c http://www.color.org/registry/profiles/PSOcoated_v3.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/PSOuncoated_v3_FOGRA52.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/PSOsc-b_paper_v3_FOGRA54.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/SC_paper_eci.icc >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/eci *.icc
            echo ">>>> Finish..."
            ;;
        --idea-icc|-i)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/idea-icc >/dev/null 2>&1
            cd $tmp/idea-icc
            echo ">>>> Download IDEAlliance ICC Profiles"
            wget -c http://www.color.org/registry/profiles/JapanColor2011Coated.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC7.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC6.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/GRACoL2013_CRPC6.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/GRACoL2006_Coated1v2.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC5.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/SWOP2013C3_CRPC5.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/SWOP2006_Coated3v2.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC4.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC3.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/GRACoL2013UNC_CRPC3.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/SWOP2006_Coated5v2.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC2.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/CGATS21_CRPC1.icc >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/idealliance *.icc
            echo ">>>> Finish..."
            ;;
        --jpma-icc|-j)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/jpma-icc >/dev/null 2>&1
            cd $tmp/jpma-icc
            echo ">>>> Download Japan Printing Machinery Association ICC Profiles"
            wget -c http://www.color.org/registry/profiles/JapanColor2011Coated.icc >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/jpma *.icc
            echo ">>>> Finish..."
            ;;
        --vigc-icc|-g)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/vigc-icc >/dev/null 2>&1
            cd $tmp/vigc-icc
            echo ">>>> Download VIGC ICC Profiles"
            wget -c http://www.color.org/registry/profiles/Coated_Fogra39L_VIGC_300.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/Coated_Fogra39L_VIGC_260.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/Uncoated_Fogra47L_VIGC_260.icc >/dev/null 2>&1
            wget -c http://www.color.org/registry/profiles/Uncoated_Fogra47L_VIGC_300.icc >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/vigc *.icc
            echo ">>>> Finish..."
            ;;
        --snap-icc|-g)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/snap-icc >/dev/null 2>&1
            cd $tmp/snap-icc
            echo ">>>> Download SNAP Committee ICC Profiles"
            wget -c http://www.color.org/registry/profiles/SNAP2007.icc >/dev/null 2>&1
            echo ">>>> Installing"
            sudo install -D -m644 -t /usr/share/color/icc/snap *.icc
            echo ">>>> Finish..."
            ;;
        --separate+|-p)
            echo ">>>> Install depedency"
            sudo xbps-install -Sy mesa-dri gimp gimp-python gimp-devel lcms lcms-devel gettext gettext-devel
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/separate+ >/dev/null 2>&1
            cd $tmp/separate+
            echo ">>>> Download source code"
            wget -ncv "https://osdn.net/projects/separate-plus/downloads/51630/separate%2B-0.5.9-alpha3.zip" -O "separate+-0.5.9-alpha3.zip" >/dev/null 2>&1
            unzip -o -q separate+-0.5.9-alpha3.zip >/dev/null 2>&1
            cd separate+-0.5.9/
            echo ">>>> Installing"
            make >/dev/null 2>&1
            sudo make PREFIX="/usr" install
            sudo install -dm755 /usr/share/gimp/2.0/scripts
            sudo install -m644 sample-scripts/* /usr/share/gimp/2.0/scripts
            echo ">>>> Finish..."
            ;;
        --corefonts|-c)
            echo ">>>> Preparing new dir /tmp"
            mkdir -p $tmp/corefonts/ >/dev/null 2>&1
            cd $tmp/corefonts/
            echo ">>>> Download Fonts"
            echo ">>>> Downloading webdin32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/webdin32.exe/download" -O webdin32.exe >/dev/null 2>&1
            echo ">>>> Downloading verdan32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/verdan32.exe/download" -O verdan32.exe >/dev/null 2>&1
            echo ">>>> Downloading trebuc32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/trebuc32.exe/download" -O trebuc32.exe >/dev/null 2>&1
            echo ">>>> Downloading times32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/times32.exe/download" -O times32.exe >/dev/null 2>&1
            echo ">>>> Downloading impact32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/impact32.exe/download" -O impact32.exe >/dev/null 2>&1
            echo ">>>> Downloading georgi32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/georgi32.exe/download" -O georgi32.exe >/dev/null 2>&1
            echo ">>>> Downloading courie32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/courie32.exe/download" -O courie32.exe >/dev/null 2>&1
            echo ">>>> Downloading comic32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/comic32.exe/download" -O comic32.exe >/dev/null 2>&1
            echo ">>>> Downloading arialb32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/arialb32.exe/download" -O arialb32.exe >/dev/null 2>&1
            echo ">>>> Downloading arial32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/arial32.exe/download" -O arial32.exe >/dev/null 2>&1
            echo ">>>> Downloading andale32 fonts"
            wget -c -nv "https://sourceforge.net/projects/corefonts/files/the%20fonts/final/andale32.exe/download" -O andale32.exe >/dev/null 2>&1
            echo ">>>> Extract fonts"
            7z -y x webdin32.exe >/dev/null 2>&1
            7z -y x verdan32.exe >/dev/null 2>&1
            7z -y x trebuc32.exe >/dev/null 2>&1
            7z -y x times32.exe >/dev/null 2>&1
            7z -y x impact32.exe >/dev/null 2>&1
            7z -y x georgi32.exe >/dev/null 2>&1
            7z -y x courie32.exe >/dev/null 2>&1
            7z -y x comic32.exe >/dev/null 2>&1
            7z -y x arialb32.exe >/dev/null 2>&1
            7z -y x arial32.exe >/dev/null 2>&1
            7z -y x andale32.exe >/dev/null 2>&1
            echo ">>>> Install to System Fonts"
            sudo mkdir -p /usr/share/fonts/corefonts/
            sudo mv *.TTF /usr/share/fonts/corefonts/
            sudo mv *.ttf /usr/share/fonts/corefonts/
            echo ">>>> Build cache fonts..."
            fc-cache -f
            sudo xbps-reconfigure -v -f fontconfig >/dev/null 2>&1
            echo ">>>> Finish..."
            ;;
        --wine-emu|-w)
            if [ $musl = 'm' ]; then
              sudo xbps-install wine wine-common wine-gecko wine-tools wine-mono winetricks zenity
              echo ">>>> Finish..."
            else
              sudo xbps-install wine wine-32bit wine-common wine-gecko wine-tools wine-mono winetricks zenity
              echo ">>>> Finish..."
            fi
            ;;
        --fish|-s)
            echo ">>>> Install Fish shell"
            sudo xbps-install -Sy fish-shell >/dev/null 2>&1
            echo ">>>> Apply Fish Shell"
            chsh -s /usr/bin/fish $USER
            cp -rf /etc/skel/.config/fish ~/.config
            echo ">>>> Finish..."
            ;;
        --fix-fonts|-f)
            sudo ln -s /usr/share/fontconfig/conf.avail/10-hinting-slight.conf /etc/fonts/conf.d/ >/dev/null 2>&1
            sudo ln -s /usr/share/fontconfig/conf.avail/10-sub-pixel-rgb.conf /etc/fonts/conf.d/ >/dev/null 2>&1
            sudo ln -s /usr/share/fontconfig/conf.avail/11-lcdfilter-default.conf /etc/fonts/conf.d/ >/dev/null 2>&1
            sudo ln -s /usr/share/fontconfig/conf.avail/50-user.conf /etc/fonts/conf.d/ >/dev/null 2>&1
            sudo ln -s /usr/share/fontconfig/conf.avail/70-no-bitmaps.conf /etc/fonts/conf.d/ >/dev/null 2>&1
            sudo xbps-reconfigure -f fontconfig
            echo ">>>> Finish..."
            ;;
        --fix-lm|-lm)
            sudo sed -i /usr/bin/lsb_release -res'#^(codename).*#codename="lite-musl"#'
            ;;
        --fix-lg|-lg)
            sudo sed -i /usr/bin/lsb_release -res'#^(codename).*#codename="lite-glibc"#'
            ;;
        --fix-pm|-pm)
            sudo sed -i /usr/bin/lsb_release -res'#^(codename).*#codename="pro-musl"#'
            ;;
        --fix-pg|-pg)
            sudo sed -i /usr/bin/lsb_release -res'#^(codename).*#codename="pro-glibc"#'
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        --version|-v)
            echo "\033[1;33m $name\033[0m version $version"
            exit 0
            ;;
        *)
            echo "Please run : \033[1;33ml7-tools --update\033[0m"
            exit 2
    esac
done
